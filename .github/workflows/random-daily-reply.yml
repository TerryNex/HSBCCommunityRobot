# This workflow runs once per day at a random time between 09:00 and 12:00 Hong Kong time (UTC+8).
# It uses a random execution logic to decide if this particular run is "the chosen one" for today.
# When triggered, it processes 15 conversations and replies to posts within the last 21 hours.

name: Random Daily Reply Bot

on:
  # Schedule: Run every 10 minutes during 9:00-12:00 HKT (1:00-4:00 UTC)
  # This gives us 18 potential runs per day in the target window
  schedule:
    - cron: '*/10 1-3 * * *'  # Every 10 minutes from 01:00 to 03:59 UTC
  
  # Manual trigger (bypasses randomness check)
  workflow_dispatch:

env:
  # Fixed parameters for this workflow
  CONVERSATION_LIMIT: '15'
  HOURS_FILTER: '21'

jobs:
  random-daily-reply:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Check if this is the chosen run for today
        id: random-check
        run: |
          # For manual triggers, always run
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Manual trigger detected, proceeding with run"
            echo "should_run=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Generate a deterministic seed based on today's date
          # This ensures all runs on the same day use the same random values
          TODAY=$(date -u +%Y%m%d)
          SEED_VALUE=$(echo -n "${TODAY}-${GITHUB_REPOSITORY}" | md5sum | cut -c1-8)
          SEED_INT=$((16#$SEED_VALUE % 100000))
          
          # Use the seed to generate a random minute within the 3-hour window (0-179)
          RANDOM=$SEED_INT
          CHOSEN_MINUTE=$((RANDOM % 180))
          
          # Calculate current minute within the window
          # Window starts at 01:00 UTC, ends at 04:00 UTC (3 hours = 180 minutes)
          CURRENT_HOUR=$(date -u +%H | sed 's/^0//')
          CURRENT_MINUTE=$(date -u +%M | sed 's/^0//')
          
          # Calculate minutes since start of window (01:00 UTC)
          if [ "$CURRENT_HOUR" -ge 1 ] && [ "$CURRENT_HOUR" -lt 4 ]; then
            MINUTES_INTO_WINDOW=$(( (CURRENT_HOUR - 1) * 60 + CURRENT_MINUTE ))
          else
            echo "Outside scheduled window, skipping"
            echo "should_run=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Check if current run is within 10 minutes of the chosen time
          DIFF=$((MINUTES_INTO_WINDOW - CHOSEN_MINUTE))
          if [ $DIFF -lt 0 ]; then
            DIFF=$((-DIFF))
          fi
          
          echo "Today's date (seed): $TODAY"
          echo "Chosen minute in window: $CHOSEN_MINUTE (out of 180)"
          echo "Current minute in window: $MINUTES_INTO_WINDOW"
          echo "Difference: $DIFF minutes"
          
          if [ $DIFF -lt 10 ]; then
            echo "This is the chosen run for today!"
            echo "should_run=true" >> $GITHUB_OUTPUT
          else
            echo "Not the chosen run, skipping"
            echo "should_run=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Exit early if not chosen
        if: steps.random-check.outputs.should_run != 'true'
        run: |
          echo "Skipping this run - not the chosen time slot for today"
          exit 0
      
      - name: Checkout repository
        if: steps.random-check.outputs.should_run == 'true'
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}
          fetch-depth: 0
      
      - name: Set up Python
        if: steps.random-check.outputs.should_run == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        if: steps.random-check.outputs.should_run == 'true'
        run: |
          pip install requests python-dotenv
      
      - name: Download previous replied posts data
        if: steps.random-check.outputs.should_run == 'true'
        continue-on-error: true
        run: |
          if [ -f replied_posts.json ]; then
            echo "replied_posts.json already exists in checkout"
          else
            echo "No previous replied_posts.json found, will start fresh"
          fi
      
      - name: Run reply bot
        if: steps.random-check.outputs.should_run == 'true'
        env:
          FORUM_BASE_URL: ${{ vars.FORUM_BASE_URL }}
          FORUM_USERNAME: ${{ vars.FORUM_USERNAME }}
          FORUM_PASSWORD: ${{ vars.FORUM_PASSWORD }}
          ROOM_TITLES: ${{ vars.ROOM_TITLES }}
          CONVERSATION_LIMIT: ${{ env.CONVERSATION_LIMIT }}
          HOURS_FILTER: ${{ env.HOURS_FILTER }}
          AI_API_KEY: ${{ vars.AI_API_KEY }}
          AI_MODEL: ${{ vars.AI_MODEL }}
          RANDOM_DELAY_RANGE: ${{ vars.RANDOM_DELAY_RANGE }}
        run: |
          echo "Running with CONVERSATION_LIMIT=$CONVERSATION_LIMIT and HOURS_FILTER=$HOURS_FILTER"
          python main.py
      
      - name: Commit and push replied posts data
        if: steps.random-check.outputs.should_run == 'true' && always()
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          if [ -f replied_posts.json ]; then
            git add replied_posts.json
            
            if git diff --staged --quiet; then
              echo "No changes to replied_posts.json, skipping commit"
            else
              git commit -m "chore: update replied posts data [skip ci]"
              git push
              echo "Successfully committed and pushed replied posts data"
            fi
          else
            echo "replied_posts.json not found, nothing to commit"
          fi
