name: List Forum Posts

on:
  workflow_dispatch:
    inputs:
      hours_filter_choice:
        description: 'Show posts within last X hours (optional)'
        required: true
        default: 'all'
        type: choice
        options:
          - 'all'
          - '12'
          - '24'
          - '48'
          - '72'
          - 'custom'
      hours_filter_custom:
        description: 'Custom hours filter (used only when choice is custom)'
        required: false
        type: string

jobs:
  list-subjects:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Install dependencies
        run: |
          pip install requests python-dotenv
      
      - name: Determine hours filter
        id: determine-hours
        run: |
          CHOICE="${{ github.event.inputs.hours_filter_choice }}"
          CUSTOM="${{ github.event.inputs.hours_filter_custom }}"
          
          if [ "$CHOICE" = "all" ]; then
            HOURS=""
            echo "Hours filter: disabled (showing all posts)"
          elif [ "$CHOICE" = "custom" ] && [ -n "$CUSTOM" ]; then
            if [[ "$CUSTOM" =~ ^[0-9]+$ ]]; then
              HOURS="$CUSTOM"
            else
              echo "Invalid custom hours value, showing all posts"
              HOURS=""
            fi
          else
            HOURS="$CHOICE"
          fi
          
          echo "hours=$HOURS" >> $GITHUB_OUTPUT
          if [ -n "$HOURS" ]; then
            echo "Hours filter: $HOURS hours"
          fi
      
      - name: List forum posts
        env:
          FORUM_BASE_URL: ${{ vars.FORUM_BASE_URL }}
          FORUM_USERNAME: ${{ vars.FORUM_USERNAME }}
          FORUM_PASSWORD: ${{ vars.FORUM_PASSWORD }}
          ROOM_TITLES: ${{ vars.ROOM_TITLES }}
          CONVERSATION_LIMIT: "30"
          HOURS_FILTER: ${{ steps.determine-hours.outputs.hours }}
        run: |
          python - <<'EOF'
          import os
          import logging
          from datetime import datetime, timezone, timedelta
          from forum_client import ForumClient
          
          # Configure logging
          logging.basicConfig(level=logging.INFO, format='%(asctime)s - %(levelname)s - %(message)s')
          logger = logging.getLogger(__name__)
          
          def parse_date(date_str):
              """Parse ISO 8601 date string to datetime object."""
              if not date_str:
                  return None
              try:
                  if '.' in date_str:
                      date_str = date_str.rstrip('Z')
                      return datetime.fromisoformat(date_str).replace(tzinfo=timezone.utc)
                  else:
                      return datetime.fromisoformat(date_str.rstrip('Z')).replace(tzinfo=timezone.utc)
              except:
                  return None
          
          def format_hk_time(date_str):
              """Convert UTC to Hong Kong time (UTC+8) and format."""
              dt = parse_date(date_str)
              if not dt:
                  return "Unknown"
              hk_tz = timezone(timedelta(hours=8))
              hk_time = dt.astimezone(hk_tz)
              return hk_time.strftime("%Y-%m-%d %H:%M:%S HKT")
          
          def is_within_hours(date_str, hours):
              """Check if date is within the last X hours."""
              if not hours:
                  return True
              dt = parse_date(date_str)
              if not dt:
                  return True
              hk_tz = timezone(timedelta(hours=8))
              now_hk = datetime.now(hk_tz)
              cutoff = now_hk - timedelta(hours=int(hours))
              return dt.astimezone(hk_tz) >= cutoff
          
          # Get hours filter
          hours_filter = os.getenv("HOURS_FILTER", "")
          hours_filter = int(hours_filter) if hours_filter and hours_filter.strip() else None
          
          logger.info("=== Listing Forum Posts ===")
          if hours_filter:
              logger.info(f"Filter: Posts within last {hours_filter} hours")
          else:
              logger.info("Filter: All posts (no time filter)")
          
          # Initialize ForumClient
          forum_url = os.getenv("FORUM_BASE_URL")
          username = os.getenv("FORUM_USERNAME")
          password = os.getenv("FORUM_PASSWORD")
          
          client = ForumClient(forum_url, username, password)
          
          # Login
          if not client.validate_session():
              if not client.login():
                  logger.error("Authentication failed.")
                  exit(1)
          
          # Get page info
          page_info = client.get_page_info()
          if not page_info:
              logger.error("Failed to get page info.")
              exit(1)
          
          page_guid = page_info.get('pageGUID')
          
          # Get rooms
          rooms = client.get_room_info(page_guid)
          if not rooms:
              logger.error("No rooms found.")
              exit(1)
          
          # Parse allowed room titles
          default_rooms = "精明消費,理財有道,環球智庫,加點保障,靈活信貸,其他"
          room_titles_str = os.getenv("ROOM_TITLES", default_rooms)
          if not room_titles_str or not room_titles_str.strip():
              room_titles_str = default_rooms
          allowed_room_titles = [title.strip() for title in room_titles_str.split(",") if title.strip()]
          
          logger.info(f"\nRoom titles: {allowed_room_titles}\n")
          
          # Collect all conversations from allowed rooms
          all_conversations = []
          for room in rooms:
              room_guid = room['roomGUID']
              room_title = room['title']
              
              if room_title not in allowed_room_titles:
                  continue
              
              conversations = client.get_conversations(room_guid, page_guid)
              for convo in conversations:
                  convo['room_title'] = room_title
                  all_conversations.append(convo)
          
          # Filter by hours if specified
          if hours_filter:
              all_conversations = [c for c in all_conversations if is_within_hours(c.get('datePosted', ''), hours_filter)]
          
          # Sort by datePosted (newest first)
          all_conversations.sort(key=lambda c: c.get('datePosted', '') or '', reverse=True)
          
          logger.info(f"Total posts found: {len(all_conversations)}")
          logger.info(f"{'='*80}")
          
          for i, convo in enumerate(all_conversations, 1):
              title = convo.get('title', 'No Title')
              content = convo.get('content', '')
              convo_id = convo.get('conversationID', '')
              username = convo.get('username', 'Unknown')
              date_posted = convo.get('datePosted', '')
              room_title = convo.get('room_title', 'Unknown')
              
              # Format time to HK timezone
              hk_time = format_hk_time(date_posted)
              
              # Preview first 100 characters of content
              preview = content[:100] + '...' if len(content) > 100 else content
              
              logger.info(f"\n{i}. [{room_title}] {hk_time}")
              logger.info(f"   ID: {convo_id}")
              logger.info(f"   Title: {title}")
              logger.info(f"   Username: {username}")
              logger.info(f"   Message: {preview}")
          
          logger.info(f"\n{'='*80}")
          logger.info("=== Listing Complete ===")
          EOF
